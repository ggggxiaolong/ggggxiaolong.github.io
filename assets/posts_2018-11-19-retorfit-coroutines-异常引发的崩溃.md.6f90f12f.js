import{_ as s,o as n,c as a,U as l}from"./chunks/framework.70292381.js";const F=JSON.parse('{"title":"Retorfit Coroutines å¼‚å¸¸å¼•å‘çš„å´©æºƒ","description":"","frontmatter":{"title":"Retorfit Coroutines å¼‚å¸¸å¼•å‘çš„å´©æºƒ","date":"2018-11-19T12:00:00.000Z","categories":["Android"],"tags":["Retorfit","Coroutines"]},"headers":[],"relativePath":"posts/2018-11-19-retorfit-coroutines-å¼‚å¸¸å¼•å‘çš„å´©æºƒ.md","filePath":"posts/2018-11-19-retorfit-coroutines-å¼‚å¸¸å¼•å‘çš„å´©æºƒ.md"}'),o={name:"posts/2018-11-19-retorfit-coroutines-å¼‚å¸¸å¼•å‘çš„å´©æºƒ.md"},p=l(`<p>æœ€è¿‘é¡¹ç›®ä¸­çªç„¶çˆ†å‘äº†ä¸€æ³¢ç”±ç½‘ç»œè¶…æ—¶é€ æˆçš„å´©æºƒé—®é¢˜(ä¹‹å‰ä¹Ÿæœ‰è¿‡å‡ æ¬¡,ä½†æ˜¯æ²¡æœ‰å¼•èµ·è¶³å¤Ÿçš„é‡è§†).èŠ±è´¹äº†ä¸€å¤©çš„æ—¶é—´ç»ˆäºè§£å†³äº†[å¼€å¿ƒ]</p><h4 id="äº‹æƒ…æ˜¯è¿™æ ·çš„" tabindex="-1">äº‹æƒ…æ˜¯è¿™æ ·çš„: <a class="header-anchor" href="#äº‹æƒ…æ˜¯è¿™æ ·çš„" aria-label="Permalink to &quot;äº‹æƒ…æ˜¯è¿™æ ·çš„:&quot;">â€‹</a></h4><p>æˆ‘åœ¨é¡¹ç›®ä¸­ä½¿ç”¨<code>kotlin</code>ä½œä¸ºå¼€å‘è¯­è¨€,åŒæ—¶ä¹Ÿå¼•å…¥äº†<code>coroutnies(åç¨‹)</code>,ä½¿ç”¨åç¨‹æ›¿ä»£äº†çº¿ç¨‹æ± .æƒ³è¦åœ¨apiå±‚ä½¿ç”¨åç¨‹,äºæ˜¯<code>Github</code>ä¸€æ³¢å†³å®šå¼•å…¥ <a href="https://github.com/JakeWharton" target="_blank" rel="noreferrer">JakeWharton</a>/<strong><a href="https://github.com/JakeWharton/retrofit2-kotlin-coroutines-adapter" target="_blank" rel="noreferrer">retrofit2-kotlin-coroutines-adapter</a></strong></p><ol><li>ä¸€å¼€å§‹è¿˜è§‰å¾—å¾ˆè¯¡å¼‚,å› ä¸ºæˆ‘åœ¨ç½‘ç»œè¯·æ±‚çš„å¤–å›´å†™äº†<code> try cache</code> æ•è·å¼‚å¸¸ç„¶åäº¤ç»™ä¸ªä¸Šå±‚åšå¤„ç†,è€Œä¸”ä¸æ˜¯æ‰€æœ‰çš„ç½‘ç»œè¶…æ—¶å¼‚å¸¸éƒ½æ•è·ä¸åˆ°</li><li>é€šè¿‡æ‰“å°æ—¥å¿—å‘ç°åªæœ‰åœ¨é¡µé¢é”€æ¯è°ƒçš„æ—¶å€™ä¼šå¼•å‘å¼‚å¸¸</li><li>ç»§ç»­è·Ÿè¸ªå‘ç°åœ¨é¡µé¢é”€æ¯çš„æ—¶å€™è°ƒç”¨<code>coroutines</code>çš„<code>job</code>å–æ¶ˆåç¨‹æ—¶ç½‘ç»œè¯·æ±‚å¹¶æ²¡ç”¨è¢«å–æ¶ˆ. ä¸Šä¸€æ®µ<a href="https://github.com/JakeWharton/retrofit2-kotlin-coroutines-adapter/blob/master/src/main/java/com/jakewharton/retrofit2/adapter/kotlin/coroutines/CoroutineCallAdapterFactory.kt" target="_blank" rel="noreferrer">ä»£ç </a>:</li></ol><div class="language-kotlin"><button title="Copy Code" class="copy"></button><span class="lang">kotlin</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">BodyCallAdapter</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">&gt;(</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">val</span><span style="color:#A6ACCD;"> responseType: </span><span style="color:#FFCB6B;">Type</span></span>
<span class="line"><span style="color:#A6ACCD;">  ) : </span><span style="color:#FFCB6B;">CallAdapter</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">, </span><span style="color:#FFCB6B;">Deferred</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">&gt;&gt; {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">override</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">fun</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">responseType</span><span style="color:#A6ACCD;">() </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> responseType</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">override</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">fun</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">adapt</span><span style="color:#A6ACCD;">(call: </span><span style="color:#FFCB6B;">Call</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">&gt;): </span><span style="color:#FFCB6B;">Deferred</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">val</span><span style="color:#A6ACCD;"> deferred </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CompletableDeferred</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">&gt;()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      deferred.</span><span style="color:#82AAFF;">invokeOnCompletion</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (deferred.isCancelled) {</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// è¿™é‡Œæ‰“å°æ—¥å¿—</span></span>
<span class="line"><span style="color:#A6ACCD;">          call.</span><span style="color:#82AAFF;">cancel</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      call.</span><span style="color:#82AAFF;">enqueue</span><span style="color:#A6ACCD;">(object : </span><span style="color:#FFCB6B;">Callback</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">override</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">fun</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">onFailure</span><span style="color:#A6ACCD;">(call: </span><span style="color:#FFCB6B;">Call</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">&gt;, t: </span><span style="color:#FFCB6B;">Throwable</span><span style="color:#A6ACCD;">) {</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">// è¿™é‡Œæ‰“å°æ—¥å¿—</span></span>
<span class="line"><span style="color:#A6ACCD;">          deferred.</span><span style="color:#82AAFF;">completeExceptionally</span><span style="color:#A6ACCD;">(t)</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">override</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">fun</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">onResponse</span><span style="color:#A6ACCD;">(call: </span><span style="color:#FFCB6B;">Call</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">&gt;, response: </span><span style="color:#FFCB6B;">Response</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">&gt;) {</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (response.isSuccessful) {</span></span>
<span class="line"><span style="color:#A6ACCD;">            deferred.</span><span style="color:#82AAFF;">complete</span><span style="color:#A6ACCD;">(response.</span><span style="color:#82AAFF;">body</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">!!</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">          } </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">            deferred.</span><span style="color:#82AAFF;">completeExceptionally</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">HttpException</span><span style="color:#A6ACCD;">(response))</span></span>
<span class="line"><span style="color:#A6ACCD;">          }</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">      })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> deferred</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span></code></pre></div><p>å‘ç°<code>cancle</code>çš„æ—¥å¿—åœ¨<code>onFailuer</code>åé¢,debugå»çœ‹æ‰å‘ç°åŸæ¥<code>deferred.isCancelled</code> è¿”å›trueæ˜¯å› ä¸º<code>deferred.completeExceptionally(t)</code> è§¦å‘çš„. å¦‚æœæ˜¯è¿™ç§åŸå› æ‰è§¦å‘å–æ¶ˆç½‘ç»œè¯·æ±‚é‚£å–æ¶ˆå°±æ²¡æœ‰æ„ä¹‰äº† ä¸‹é¢è¿™ä¸¤ä¸ªæ˜¯è¿™ä¸ªåº“çš„issues: [1] <a href="https://github.com/JakeWharton/retrofit2-kotlin-coroutines-adapter/issues/7" target="_blank" rel="noreferrer">[Question] Coroutine cancellation is not handled, right? #7</a> [2] <a href="https://github.com/JakeWharton/retrofit2-kotlin-coroutines-adapter/issues/33" target="_blank" rel="noreferrer">Is there any way to catch timeout exception using your coroutines?</a> æƒ³äº†åŠå¤©ä¹Ÿæ²¡åŠæ³•æŠŠ<code>job</code>æˆ–è€…<code>coroutinesContext</code>ä¼ ç»™apiè¿”å›çš„<code>Deferred</code>å¯¹è±¡,è€Œä¸”<code>suspend</code>æ–¹æ³•ä¹Ÿä¸èƒ½è·å– <code>coroutinesContext</code>å¯¹è±¡æ‰€ä»¥æœ€ç»ˆåªèƒ½åœ¨è°ƒç”¨çš„æ—¶å€™æŠŠ<code>job</code> å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ åˆ°ä¸‹å±‚äº†...è™½ç„¶ä¸ä¼˜é›…ä½†æ˜¯èƒ½è§£å†³é—®é¢˜äº†</p><blockquote><p>å¦‚æœä½ ä¹Ÿé‡åˆ°äº†è¿™æ ·çš„é—®é¢˜å¸Œæœ›æˆ‘çš„è§£å†³æ–¹æ³•èƒ½ç»™ä½ ä¸€ä¸ªæ€è·¯,å¦‚æœä½ æœ‰æ›´å¥½çš„è§£å†³æ–¹æ³•è¯·ä½ ä¹Ÿå‘Šè¯‰æˆ‘ä¸€å£° ğŸ˜„ å†™ä¸€ä¸‹ä¼ªä»£ç :</p></blockquote><div class="language-kotlin"><button title="Copy Code" class="copy"></button><span class="lang">kotlin</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// api service</span></span>
<span class="line"><span style="color:#C792EA;">fun</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">api</span><span style="color:#A6ACCD;">(): </span><span style="color:#FFCB6B;">Deferred</span><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">String</span><span style="color:#A6ACCD;">&gt; </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CompletableDeferred</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Activity</span><span style="color:#A6ACCD;">(): </span><span style="color:#FFCB6B;">CoroutineScope</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">val</span><span style="color:#A6ACCD;"> job </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Job</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">override</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">val</span><span style="color:#A6ACCD;"> coroutineContext: </span><span style="color:#FFCB6B;">CoroutineContext</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Dispatchers.Default </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> job</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">fun</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">runApi</span><span style="color:#A6ACCD;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">launch</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">val</span><span style="color:#A6ACCD;"> deferred </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">api</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">      job.</span><span style="color:#82AAFF;">invokeOnCompletion</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (job.isCancelled)</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">// åœ¨æ£€æµ‹åˆ°jobå–æ¶ˆçš„æ—¶å€™å–æ¶ˆç½‘ç»œè¯·æ±‚</span></span>
<span class="line"><span style="color:#A6ACCD;">          deferred.</span><span style="color:#82AAFF;">cancel</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">      }</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">val</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> deferred.</span><span style="color:#82AAFF;">await</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;">//todo</span></span>
<span class="line"><span style="color:#A6ACCD;">      } </span><span style="color:#89DDFF;">catch</span><span style="color:#A6ACCD;"> (t: </span><span style="color:#FFCB6B;">Throwable</span><span style="color:#A6ACCD;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;">// exception control</span></span>
<span class="line"><span style="color:#A6ACCD;">      }</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">fun</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">destory</span><span style="color:#A6ACCD;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">    job.</span><span style="color:#82AAFF;">cancel</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><h4 id="emmm-è¿˜æ˜¯æ‰“ç®—æ’ä¸€å¥ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ä¸ªåº“" tabindex="-1">emmm è¿˜æ˜¯æ‰“ç®—æ’ä¸€å¥ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ä¸ªåº“: <a class="header-anchor" href="#emmm-è¿˜æ˜¯æ‰“ç®—æ’ä¸€å¥ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ä¸ªåº“" aria-label="Permalink to &quot;emmm  è¿˜æ˜¯æ‰“ç®—æ’ä¸€å¥ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ä¸ªåº“:&quot;">â€‹</a></h4><p>ç”±äºç½‘ç»œè¯·æ±‚æ˜¯è¶…æ—¶æ“ä½œ,è€Œå®‰å“çš„é¡µé¢[activity, fragment]ä»€ä¹ˆæ—¶å€™é”€æ¯ä¸€èˆ¬æ˜¯ç”±ç”¨æˆ·æ“ä½œå†³å®šçš„.æ‰€ä»¥ä¼šæœ‰ç”Ÿå‘½å‘¨æœŸä¸ä¸€è‡´çš„é—®é¢˜,ç½‘ç»œè¯·æ±‚åˆä¼šæŒæœ‰é¡µé¢çš„ç´¢å¼•[å†…éƒ¨ç±»,ä¼šæŒæœ‰å¤–éƒ¨ç±»çš„ç´¢å¼•].æ‰€ä»¥åœ¨è®¾è®¡çš„æ—¶å€™ä¸€èˆ¬ä¼šåœ¨é¡µé¢é”€æ¯çš„æ—¶å€™å–æ¶ˆç½‘ç»œè¯·æ±‚,æœ€å¼€å§‹ä½¿ç”¨çš„æ˜¯<code>RxJava + CompositeDisposable </code> åœ¨é¡µé¢é”€æ¯çš„æ—¶å€™é€šè¿‡è°ƒç”¨ <code>CompositeDisposable</code> çš„ close æ–¹æ³•å–æ¶ˆç½‘ç»œè¯·æ±‚,ä¹‹åä½¿ç”¨<code>LiveData + RxJava + AutoDispose</code> åæ¥è§‰å¾—æ—¢ç„¶å¼•å…¥äº†<code>LiveData</code> åœ¨å¼•å…¥ <code>RxJava</code>æœ‰äº›å¤šä½™äº†(å› ä¸ºå¤§éƒ¨åˆ†RxJavaçš„ä½¿ç”¨åœºæ™¯éƒ½åœ¨ç½‘ç»œè¯·æ±‚ä¸Š),åŒæ—¶ä¹Ÿæ¥è§¦äº† <code>koltin</code> çš„<code>coroutnies</code> æ‰¾åˆ°äº†å¤§ç¥å†™çš„åº“ç«Ÿç„¶ä¸ç”¨å…³å¿ƒç½‘ç»œè¯·æ±‚çš„å–æ¶ˆ[å—¯,å¤§ç¥å°±æ˜¯å¤§ç¥]äºæ˜¯å°±å¼•å…¥äº†...</p>`,10),e=[p];function t(c,r,C,A,y,i){return n(),a("div",null,e)}const d=s(o,[["render",t]]);export{F as __pageData,d as default};
