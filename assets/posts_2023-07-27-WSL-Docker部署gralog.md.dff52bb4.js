import{_ as s,o as a,c as n,U as l}from"./chunks/framework.70292381.js";const o="/assets/20230727151942.e3c351b1.png",d=JSON.parse('{"title":"WSL Docker 部署 Graylog","description":"","frontmatter":{"title":"WSL Docker 部署 Graylog","date":"2023-07-27T00:00:00.000Z","categories":["Docker"],"tags":["graylog"]},"headers":[],"relativePath":"posts/2023-07-27-WSL-Docker部署gralog.md","filePath":"posts/2023-07-27-WSL-Docker部署gralog.md"}'),p={name:"posts/2023-07-27-WSL-Docker部署gralog.md"},e=l(`<h3 id="wsl-docker-部署-graylog" tabindex="-1">WSL Docker 部署 Graylog <a class="header-anchor" href="#wsl-docker-部署-graylog" aria-label="Permalink to &quot;WSL Docker 部署 Graylog&quot;">​</a></h3><h4 id="容器遇到的问题" tabindex="-1">容器遇到的问题： <a class="header-anchor" href="#容器遇到的问题" aria-label="Permalink to &quot;容器遇到的问题：&quot;">​</a></h4><ol><li><p>parsing /home/mrtan/docker-graylog-compose.yml: yaml: line 6: mapping values are not allowed in this context 问题描述：官方的graylog的compose配置 有几个配置没有添加空格区分层级，需要通过添加区别层级</p></li><li><p>error getting credentials - err: exec: &quot;docker-credential-desktop.exe&quot;: executable file not found in $PATH, out: \`\` 问题描述：缺少程序，需要到仓库 <a href="https://github.com/docker/docker-credential-helpers" target="_blank" rel="noreferrer">docker-credential-helpers</a> 下载最新的程序，并添加到系统环境中</p></li><li><p>mongodb 容器运行就结束，查看日志 <code>Operation not permitted</code><br> 问题描述：Windows和OS X上的默认Docker设置使用VirtualBox VM来托管Docker守护程序。不幸的是，VirtualBox用于在主机系统和Docker容器之间共享文件夹的机制与MongoDB使用的内存映射文件不兼容（请参阅vbox bug，docs.mongodb.org和相关的jira.mongodb.org错误）。这意味着无法运行映射到主机的数据目录的MongoDB容器。 而且 wsl docker 会占用c盘的空间 解决方案：迁移 docker镜像</p><div class="language-powershell"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">//</span><span style="color:#A6ACCD;"> 打包当前的镜像</span></span>
<span class="line"><span style="color:#A6ACCD;">wsl </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">export docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop E:\\docker\\wsl\\docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop\\docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop.tar</span></span>
<span class="line"><span style="color:#A6ACCD;">wsl </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">export docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">data E:\\docker\\wsl\\docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">data\\docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">data.tar</span></span>
<span class="line"><span style="color:#89DDFF;">//</span><span style="color:#A6ACCD;">删除之前的镜像</span></span>
<span class="line"><span style="color:#A6ACCD;">wsl </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">unregister docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">data </span></span>
<span class="line"><span style="color:#A6ACCD;">wsl </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">unregister docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">data</span></span>
<span class="line"><span style="color:#89DDFF;">//</span><span style="color:#A6ACCD;">导入镜像</span></span>
<span class="line"><span style="color:#A6ACCD;">wsl </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">import docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop E:\\docker\\wsl\\docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop\\ E:\\docker\\wsl\\docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop\\docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop.tar </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">version </span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">wsl </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">import docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">data E:\\docker\\wsl\\docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">data\\ E:\\docker\\wsl\\docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">data\\docker</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">desktop</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">data.tar </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">version </span><span style="color:#F78C6C;">2</span></span></code></pre></div></li><li><p>最终启动文件</p><div class="language-yml"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">version</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">3</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">services</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># MongoDB: https://hub.docker.com/_/mongo/</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">mongo</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">container_name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mongo</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mongo:6.0.8</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/localtime:/etc/localtime</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mongo_data:/data/db</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">networks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">graylog</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Elasticsearch: https://www.elastic.co/guide/en/elasticsearch/reference/7.10/docker.html</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">elasticsearch</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker.elastic.co/elasticsearch/elasticsearch-oss:7.10.2</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">container_name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">elasticsearch</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">environment</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">http.host=0.0.0.0</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">transport.host=localhost</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">network.host=0.0.0.0</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ES_JAVA_OPTS=-Dlog4j2.formatMsgNoLookups=true -Xms512m -Xmx512m</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/localtime:/etc/localtime</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">es_data:/usr/lib/elasticsearch/data</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">es_logs:/usr/lib/elasticsearch/logs</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">ulimits</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">memlock</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">soft</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">-1</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">hard</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">-1</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">deploy</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">resources</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">limits</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">memory</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">1g</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">networks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">graylog</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Graylog: https://hub.docker.com/r/graylog/graylog/</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">graylog</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">graylog/graylog:5.1.3</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">container_name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">graylog</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">environment</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 生成密码的指令 echo -n &quot;Enter Password: &quot; &amp;&amp; head -1 &lt; /dev/stdin | tr -d &#39;\\n&#39; | sha256sum | cut -d &quot; &quot; -f1</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># CHANGE ME (must be at least 16 characters)!</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">GRAYLOG_PASSWORD_SECRET=somepasswordpepper</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Password: admin</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">GRAYLOG_ROOT_PASSWORD_SHA2=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">GRAYLOG_HTTP_EXTERNAL_URI=http://127.0.0.1:9000/</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">entrypoint</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/bin/tini -- wait-for-it elasticsearch:9200 --  /docker-entrypoint.sh</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">networks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">graylog</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#     restart: always</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">depends_on</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mongo</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">elasticsearch</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 端口配置, 如果需要开其他的端口,需要在这里增加</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Graylog web interface and REST API</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">9000:9000</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Syslog TCP</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">1514:1514</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Syslog UDP</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">1514:1514/udp</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># GELF TCP</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">12201:12201</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># GELF UDP</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">12201:12201/udp</span></span>
<span class="line"><span style="color:#F07178;">networks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">graylog</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#F07178;">driver</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bridge</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">mongo_data</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">es_data</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">es_logs</span><span style="color:#89DDFF;">:</span></span></code></pre></div></li></ol><h4 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-label="Permalink to &quot;配置&quot;">​</a></h4><ol><li><p>开启 http 接口: System/Indices &gt;&gt; Inputs &gt;&gt; select input 选择 GELF HTTP 点击 Launch new input &gt;&gt; 输入 tiltle， 端口 保存</p></li><li><p>设置定期(6个月，183天)删除日志： System/Indices &gt;&gt; Indices &gt;&gt; Default index set &gt;&gt; Edit</p><ol><li><p>Select rotation strategy &gt;&gt; Index Time</p></li><li><p>Rotation period (ISO8601 Duration) &gt;&gt; P1D</p></li><li><p>Select retention strategy &gt;&gt; Delete Index</p></li><li><p>Max number of indices &gt;&gt; 183</p></li></ol></li><li><p>其他 集成Spring boot， 邮箱/http通知， 测试/正式分开， tcp/udp端口， rsyslog， <a href="https://blog.csdn.net/liuyij3430448/article/details/127609313" target="_blank" rel="noreferrer">参考文档</a></p></li></ol><h4 id="使用" tabindex="-1">使用 <a class="header-anchor" href="#使用" aria-label="Permalink to &quot;使用&quot;">​</a></h4><p>前面已经开启了 http 端口， 访问的地址: <a href="http://ip" target="_blank" rel="noreferrer">http://ip</a>:port/grel 例如 <a href="http://192.168.20.64:12201/gelf" target="_blank" rel="noreferrer">http://192.168.20.64:12201/gelf</a> post请求方式。json 传输</p><table><thead><tr><th>字段</th><th>描述</th></tr></thead><tbody><tr><td>short_message</td><td>信息</td></tr><tr><td>host</td><td>来源</td></tr><tr><td>level</td><td>日志级别</td></tr><tr><td>其他自定义字段</td><td></td></tr></tbody></table><p>检索日志：</p><p>过滤规则 <a href="https://go2docs.graylog.org/5-1/making_sense_of_your_log_data/writing_search_queries.html?Highlight=queries" target="_blank" rel="noreferrer">官方文档</a></p><p>指定日志搜索时的关键字或条件表达式，可以是某个单独的“关键字”或“指定某个字段的值”。可以使用“AND”、“OR”、“NOT”进行多条件查询搜索</p><ol><li><strong>模糊查询</strong>：直接输入  baseid</li><li><strong>精确查询</strong>：加引号   “baseid”</li><li><strong>字段查询</strong>： team:base  其中 team 的值主要有 <strong>base</strong></li><li><strong>多字段查询</strong>：ztyq:(base-service base-web)</li><li><strong>多条件查询</strong>：team:base AND ztyq:base-web OR source:192.168.0.4</li><li><strong>正则匹配查询</strong>：ztyq:base-web AND baseid:12?4*</li><li>包含字段的查询： <em>exists</em>:type</li><li>数字的区间查询： http_response_code:[500 TO 504]</li></ol><p><img src="`+o+'" alt="img"></p>',13),t=[e];function r(c,D,y,C,i,A){return a(),n("div",null,t)}const g=s(p,[["render",r]]);export{d as __pageData,g as default};
